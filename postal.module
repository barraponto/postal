<?php
/*
  TODO/wishlist:
   - doesn't appear to be saving entries appropriately
   - Get ISO-3166-1 (and -2??) data for countries (and states??)
   - implement a nicer theme for form, including dropdowns and stuff
   - widget settings to show/hide various fields (names, country, etc.) 
   - Add field_settings:tables/arguments/filters for field components (zip, street, etc)
*/

function postal_field_info() {
  return array(
    'postal' => array('label' => t('Postal Address')),
  );
}

function postal_field($op, &$node, $field, &$node_field, $teaser, $page) {
  switch ($op) {
    case 'validate':
  }
}

function postal_field_settings($op, $field) {
  switch ($op) {
    case 'database columns':
      return postal_field_list();
  }
}

function postal_widget_info() {
  return array(
    'postal' => array(
      'label' => t('Address form'),
      'field types' => array('postal'),
    ),
  );
}

/**
 * Implementation of hook_field_formatter_info().
 */
function postal_field_formatter_info() {
  return array(
    'default' => array(
      'label' => 'Default',
      'field types' => array('postal'),
    ),
    'address_google' => array(
      'label' => 'Address with google link',
      'field types' => array('postal'),
    ),
    
  );
}

/**
 * Implementation of hook_field_formatter().
 */
function postal_field_formatter($field, $item, $formatter, $node) {

  // scaffolding in room for more formatters later (e.g. vcard, hcard, etc)
  switch($formatter) {
    case 'address_google':
      return theme('postal_address', $item, true);
    default: // the literal default string, actually
      return theme('postal_address', $item);
  }
}

function postal_widget($op, &$node, $field, &$items) {

  switch ($op) {
    case 'form':
      // general set up for all postals
      $name = $field['field_name'];
      $form = array();
      $form[$name]['#type'] = 'fieldset';
      $form[$name]['#tree'] = true;
      $form[$name]['#title'] = $field['widget']['label'];

      if (!$items || $field['multiple']) {
        $items[] = (array) postal_address();
      }
      
      foreach ($items as $delta => $data) {
        $data['id'] = $name.'-'.$delta;
        $o = (object) $data;
        $form[$name][$delta] = postal_form($o);
      }

      return $form;
      
    case 'process form values':
      // nothing to do right now. scaffolding this in for later
      break;
  }
}

function postal_field_list() {
  $fields = array(
    'type'       => array('type' => 'varchar', 'length' => 100, 'sortable' => true),
    'name'       => array('type' => 'varchar', 'length' => 100, 'sortable' => true),
    'street1'    => array('type' => 'varchar', 'length' => 64, 'sortable' => false),
    'street2'    => array('type' => 'varchar', 'length' => 64, 'sortable' => false),
    'zip'        => array('type' => 'varchar', 'length' => 10, 'sortable' => true),
    'city'       => array('type' => 'varchar', 'length' => 32, 'sortable' => true),
    'state'      => array('type' => 'varchar', 'length' => 32, 'sortable' => true),
    'country'    => array('type' => 'varchar', 'length' => 2, 'sortable' => true),
  );
  return $fields;
}

/* 
 *
 */
 // MARK - $values is never used in this function. what is it for?
 // Also, postal_form can handle $address as string. I don't think we can cast strings to objects
function postal_address($address=null, $id=null, $values=array()) {
  $fields = array_keys(postal_field_list());

  if (!$address) {
    $address = new stdClass();
    $address->id = $id ? $id : 'default';
  }
  else {
    $address = (object) $address; // MARK - address might be a string according to postal_form
  }
  
  $address->empty = true;
  
  foreach ($fields as $field) {
    if(!array_key_exists($field, $address)) {
      $address->$field = '';
    }
    elseif($address->$field) $address->empty = false;
  }

  foreach($values as $key => $val) {
    if (($field = str_replace('postal_'.$id.'_', '', $key)) != $key) {
      if (in_array($field, $fields)) {
        $address->$field = $val;
      }
    }
  }

  return $address;
}

// MARK - Allie, can you write up a comment on this what form an address is supposed to take
// (e.g. a vardump of a valid address)
// also, I don't see values used in this function (just like postal_address())
function postal_form(&$address, $fields=array(), $values=array()) {
  // TODO - do we still need to be cognizant of the id?  Or just assume
  // that the calling code to keep track of its own stuff?

  $id = is_object($address) ? $address->id : $address;
  $id = check_plain($id);

  // initialize the address 
  postal_address($address, $id, $values);

  $form = array();
  $form['address'] = array(
    '#type' => 'value',
    '#value' => $address,
  );
  $form['street1'] = array(
    '#type' => 'textfield',
    '#title' => t('Street Address'),
    '#default_value' => $address->street1,
    '#size' => 50,
    '#maxlength' => 75,
    '#required' =>  $address->required,
  );
  $form['street2'] = array(
    '#type' => 'textfield',
    '#title' => '',
    '#default_value' => $address->street2,
    '#size' => 50,
    '#maxlength' => 75,
    '#required' => false,
  );
  $form['city'] = array(
    '#type' => 'textfield',
    '#title' => t('City'),
    '#default_value' => $address->city,
    '#size' => 30,
    '#maxlength' => 64,
    '#required' => $address->required,
  );
  $form['state'] = array(
    '#type' => 'textfield',
    '#title' => t('State / Province'),
    '#default_value' => $address->state,
    '#size' => 30,
    '#maxlength' => 64,
  );
  $form['zip'] = array(
    '#type' => 'textfield',
    '#title' => t('Zip / Postal Code'),
    '#default_value' => $address->zip,
    '#size' => 20,
    '#maxlength' => 20,
    '#required' => $address->required,
  );

  // only show requested fields
  if ($fields) {
    foreach($form as $field => $val) {
      if(!in_array(''.$field, $fields)) unset($form[$field]);
    }
  }
  return $form;
}

function theme_postal_address($address, $google = false) {
  
  $address = (object) $address;
  
  if ($address->view) {
    return $address->view;
  }
  
  $out = '';
  if($address->name)        $out .= $address->name;
  if($address->street1)     $out .= '<br />'.$address->street1;
  if($address->street2)     $out .= '<br />'.$address->street2;
  if($address->city || $address->state || $address->zip) $out .= '<br />';
  if($address->city)        $out .= $address->city . ', ';
  if($address->state)       $out .= $address->state . ' ';
  if($address->zip)         $out .= $address->zip;
  if($address->country)     $out .= '<br />'.$address->country;
  
  if ($google) {
    $acc = array();
    foreach(array('street1', 'street2', 'city', 'state', 'zip', 'country') as $key) {
      if ($address->{$key}) {
        $acc[] = $address->{$key};
      }
    } 
    if ($acc) {
      $gqs = urlencode(implode(', ', $acc));
      $out .= '<br />' . l(t('Google Map'), 'http://maps.google.com/maps', array(), "q=$gqs", NULL);
    }
  }
  
  return $out;
}    
