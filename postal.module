<?php // $Id$

/**
 * Implementation of hook_elements().
 */
function postal_elements() {
  return array(
    'postal' => array(
      '#input' => TRUE,
      '#process' => array('postal_process'),
    ),
  );
}

/**
 *
 */
function postal_address($address=null, $id=null, $values=array()) {
  $fields = array_keys(postal_database_columns());

  if (!$address) {
    $address = new stdClass();
    $address->id = $id ? $id : 'default';
  }
  else {
    $address = (object) $address; // MARK - address might be a string according to postal_form
  }
  
  $address->empty = true;
  
  foreach ($fields as $field) {
    if (!array_key_exists($field, $address)) {
      $address->$field = '';
    }
    elseif ($address->$field) $address->empty = false;
  }

  return $address;
}

function postal_process(&$element, $form_state) {
  $element['#tree'] = TRUE;

  $id = is_object($address) ? $address->id : $address;
  $id = check_plain($id);

  if (isset($element['#postal_address'])) {
    $address = postal_address($element['#postal_address']);
  }
  elseif (isset($element['#default_value'])) {
    $address = postal_address($element['#default_value']);
  }

  $element['#prefix'] = '<div class="postal-form">';
  $element['#suffix'] = '</div>';
  $element['street1'] = array(
    '#type' => 'textfield',
    '#title' => $element['#title'] ? $element['#title'] : t('Street Address'),
    '#default_value' => $address->street1,
    '#size' => 50,
    '#maxlength' => 75,
    '#required' => $element['#required'],
  );
  $element['street2'] = array(
    '#type' => 'textfield',
    '#title' => '',
    '#default_value' => $address->street2,
    '#size' => 50,
    '#maxlength' => 75,
  );
  $element['locale'] = array(
    '#prefix' => '<div class="postal-locale">',
    '#suffix' => '</div><div style="clear: both"/>',
  );
  $element['locale']['city'] = array(
    '#type' => 'textfield',
    '#title' => t('City'),
    '#default_value' => $address->city,
    '#size' => 15,
    '#maxlength' => 64,
    '#parents' => array_merge($element['#parents'], array('city')),
    '#required' => $element['#required'],
  );
  $element['locale']['state'] = array(
    '#type' => 'textfield',
    '#title' => t('State/Province'),
    '#default_value' => $address->state,
    '#parents' => array_merge($element['#parents'], array('state')),
    '#size' => 12,
    '#maxlength' => 64,
    '#required' => $element['#required'],
  );
  $element['locale']['zip'] = array(
    '#type' => 'textfield',
    '#title' => t('Postal Code'),
    '#default_value' => $address->zip,
    '#parents' => array_merge($element['#parents'], array('zip')),
    '#size' => 10,
    '#maxlength' => 20,
    '#required' => $element['#required'],
  );

  // Only show requested fields.
  if (isset($element['#postal_fields'])) {
    foreach ($element as $field => $val) {
      if (!in_array(''. $field, $element['#postal_fields'])) {
        $element[$field]['#access'] = FALSE;
      }
    }
  }

  // The title was used on the street1 field.  It's redundant now.
  if (isset($element['street1'])) unset($element['#title']);

  // "Required" was passed through to the sub-elements.
  unset($element['#required']);

  return $element;
}

function postal_database_columns() {
  return array(
    'type'    => array('type' => 'varchar', 'length' => 100, 'sortable' => true),
    'name'    => array('type' => 'varchar', 'length' => 100, 'sortable' => true),
    'street1' => array('type' => 'varchar', 'length' => 64, 'sortable' => false),
    'street2' => array('type' => 'varchar', 'length' => 64, 'sortable' => false),
    'zip'     => array('type' => 'varchar', 'length' => 10, 'sortable' => true),
    'city'    => array('type' => 'varchar', 'length' => 32, 'sortable' => true),
    'state'   => array('type' => 'varchar', 'length' => 32, 'sortable' => true),
    'country' => array('type' => 'varchar', 'length' => 2, 'sortable' => true),
  );
}

/**
 * Implementation of hook_theme().
 */
function postal_theme() {
  return array(
    'postal' => array('arguments' => array('element' => NULL)),
    'postal_address' => array('arguments' => array('address' => NULL)),
  );
}

function theme_postal($element) {
  drupal_add_css(drupal_get_path('module', 'postal') . '/postal.css', all);
  return $element['#children'];
}

function theme_postal_address($address) {
  $address = (object) $address;
  $out = '';
  if ($address->name)        $out .= $address->name;
  if ($address->street1)     $out .= '<br />'. $address->street1;
  if ($address->street2)     $out .= '<br />'. $address->street2;
  if ($address->city || $address->state || $address->zip) $out .= '<br />';
  if ($address->city)        $out .= $address->city .', ';
  if ($address->state)       $out .= $address->state .' ';
  if ($address->zip)         $out .= $address->zip;
  if ($address->country)     $out .= '<br />'. $address->country;
  
  return $out;
}
